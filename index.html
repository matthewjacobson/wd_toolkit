<!DOCTYPE html>
<html lang="en">
  
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="https://glitch.com/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Watercolor Dreams Toolkit</title>

    <link rel="stylesheet" href="style.css" />
    
  </head>
  
  <body>
    
    <div class="navbar">
      <div class="onboard">
        <button class="metamask">Connect to MetaMask</button>
      </div>
      <div class="dropdown">
        <button class="dropbtn">Your Watercolor Dreams â–¼</button>
        <div class="dropdown-content">
          <a>Test</a>
        </div>
      </div>
    </div>
        
    <script src="./metamask-onboarding.bundle.js"></script>
    <script>
      
      let tokenData;
      
      const assetsList = document.getElementsByClassName("dropdown-content")[0];
      
      function httpGetAsync(theUrl, callback) {
        var xmlHttp = new XMLHttpRequest();
        xmlHttp.onreadystatechange = function() { 
            if (xmlHttp.readyState == 4 && xmlHttp.status == 200) callback(xmlHttp.responseText);
        }
        xmlHttp.open("GET", theUrl, true); // true for asynchronous 
        xmlHttp.send(null);
      }
      
      function updateToken(responseString) {
        let apiInfo = JSON.parse(responseString);
        console.log(apiInfo);
        tokenData = {"hash": apiInfo["token hash"], "tokenId": apiInfo["tokenID"]};
      }
      
      function updateAssetList(responseString) {
        let assets = JSON.parse(responseString).assets;
        for (let i = 0; i < assets.length; i++) {
          if (assets[i].token_id.substring(0, 2) == "59") {
            let node = document.createElement("A");
            node.innerText = assets[i].token_id;
            assetsList.appendChild(node);
            node.onClick = () => { httpGetAsync('https://api.artblocks.io/token/' + assets[i].token_id, updateToken); };
          }
        }
      }
      
      function getAssetsInWallet(walletAddress) {
        httpGetAsync('https://api.opensea.io/api/v1/assets?order_direction=desc&offset=0&limit=20&owner=' + walletAddress, updateAssetList);
      }
      
      window.addEventListener('DOMContentLoaded', () => {
        const onboarding = new MetaMaskOnboarding();
        const onboardButton = document.getElementsByClassName("metamask")[0];
        let accounts;

        const updateButton = () => {
          if (!MetaMaskOnboarding.isMetaMaskInstalled()) {
            onboardButton.innerText = 'Click here to install MetaMask!';
            onboardButton.onclick = () => {
              onboardButton.innerText = 'Onboarding in progress';
              onboardButton.disabled = true;
              onboarding.startOnboarding();
            };
          } else {
            if (accounts && accounts.length > 0) {
              onboardButton.innerText = 'Connected';
              onboardButton.disabled = true;
              onboarding.stopOnboarding();
              getAssetsInWallet(accounts[0]);
            } else {
              onboardButton.innerText = 'Connect';
              onboardButton.onclick = async () => {
                accounts = await window.ethereum.request({method: 'eth_requestAccounts'});
                updateButton();
              };
            }
          }
        };
        
        updateButton();
        if (MetaMaskOnboarding.isMetaMaskInstalled()) {
          window.ethereum.on('accountsChanged', (newAccounts) => {
            accounts = newAccounts;
            updateButton();
          });
        }
      });
      
    </script>
    
  </body>
</html>
